<!-- src/app/components/popup/popup.html -->
<div class="popup-wrapper">
  <p-button
    styleClass="open-request-btn"
    label="Open Request"
    icon="pi pi-external-link"
    (onClick)="showDialog()"
  ></p-button>

  <p-dialog
    [header]="request.heading || 'Help Request'"
    [(visible)]="visible"
    [modal]="true"
    [style]="{ width: '70rem', height: '90vh' }"
    [breakpoints]="{ '1199px': '90vw', '575px': '95vw' }"
    [contentStyle]="{ padding: '0', height: 'calc(90vh - 80px)', display: 'flex', flexDirection: 'column' }"
    [maximizable]="true"
    styleClass="chat-dialog"
  >
    <!-- Request Details Header (removed description, kept cost and status) -->
    <div class="request-details-header">
      <div class="request-info-grid">
        <div class="request-detail-item">
          <span class="detail-label">Cost:</span>
          <span class="detail-value cost-value">${{ request.cost.toFixed(2) }}</span>
        </div>
        
        <div class="request-detail-item">
          <span class="detail-label">Status:</span>
          <span class="detail-value status-value" [class]="'status-' + request.status.toLowerCase()">
            {{ request.status }}
          </span>
        </div>
      </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <!-- Accept Chat Prompt -->
      <div *ngIf="!chatAccepted && request.status === 'PENDING'" class="accept-chat-section">
        <div class="accept-chat-card">
          <div class="accept-icon">ðŸ’¬</div>
          <h3 class="accept-title">Join Team Chat</h3>
          <p class="accept-description">The team has invited you to join the conversation. Accept to start chatting.</p>
          <p-button
            styleClass="accept-chat-btn"
            label="Accept & Join Chat"
            icon="pi pi-check"
            (onClick)="acceptChat()"
            [loading]="loading"
          ></p-button>
        </div>
      </div>

      <!-- Error Message -->
      <div *ngIf="error" class="error-banner">
        <div class="error-content">
          <i class="pi pi-exclamation-triangle error-icon"></i>
          <span class="error-text">{{ error }}</span>
          <button (click)="clearError()" class="error-close">
            <i class="pi pi-times"></i>
          </button>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div *ngIf="loading && !messages.length" class="loading-section">
        <div class="loading-spinner">
          <i class="pi pi-spinner pi-spin"></i>
          <p class="loading-text">Loading chat...</p>
        </div>
      </div>

      <!-- Chat Messages Area -->
      <div #chatScroll class="chat-messages-area">
        <div class="messages-container">
          <ng-container *ngFor="let msg of messages; trackBy: trackByMessageId">
            
            <!-- System Messages -->
            <div *ngIf="msg.type === 'system'" class="system-message">
              <div class="system-message-content">
                <i class="pi pi-info-circle system-icon"></i>
                <span>{{ msg.text }}</span>
              </div>
            </div>

            <!-- Chat Messages -->
            <div *ngIf="msg.type === 'text'" class="message-wrapper" [class.own-message]="msg.sender === 'me'">
              <div class="message-bubble" [class.own-bubble]="msg.sender === 'me'">
                
                <!-- Message Header -->
                <div class="message-header">
                  <span class="sender-name">{{ msg.senderName }}</span>
                  <span class="message-time">{{ msg.timestamp | date: 'shortTime' }}</span>
                </div>

                <!-- Message Content -->
                <div class="message-content">
                  <!-- Text Content -->
                  <div *ngIf="msg.text" class="message-text">{{ msg.text }}</div>
                  
                  <!-- Images -->
                  <div *ngIf="msg.images && msg.images.length > 0" class="message-images">
                    <img 
                      *ngFor="let imageUrl of msg.images" 
                      [src]="imageUrl"
                      alt="Message image"
                      class="message-image"
                    />
                  </div>
                </div>
              </div>
            </div>

          </ng-container>
        </div>
      </div>

      <!-- Message Input Area -->
      <div *ngIf="chatAccepted" class="chat-input-section">
        <div class="input-container">
          <div class="input-wrapper">
            <input
              type="text"
              [(ngModel)]="newMessage"
              placeholder="Type your message..."
              (keydown)="onInputKeydown($event)"
              class="message-input"
              autocomplete="off"
              [disabled]="loading"
            />
            <p-button
              styleClass="send-button"
              icon="pi pi-paper-plane"
              (onClick)="sendMessage()"
              [disabled]="!newMessage.trim() || loading"
            ></p-button>
          </div>
        </div>
      </div>
    </div>
  </p-dialog>
</div>