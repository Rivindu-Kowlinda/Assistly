<div class="popup-wrapper">
  <p-dialog
    [header]="isRequest ? 'Request Chat' : 'Help Review'"
    [(visible)]="visible"
    [modal]="true"
    [style]="{ width: '70rem', height: '90vh' }"
    [breakpoints]="{ '1199px': '90vw', '575px': '95vw' }"
    [contentStyle]="{ padding: '0', height: 'calc(90vh - 80px)', display: 'flex', flexDirection: 'column' }"
    [maximizable]="true"
    styleClass="chat-dialog"
    (onHide)="onDialogHide()"
  >
    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-section">
      <div class="loading-spinner">
        <i class="pi pi-spinner pi-spin"></i>
        <p class="loading-text">Loading...</p>
      </div>
    </div>

    <!-- Content shown only when not loading -->
    <div *ngIf="!isLoading" class="chat-container">
      <!-- Chat Messages Area -->
      <div #chatScroll class="chat-messages-area">
        <div class="messages-container">
          <ng-container *ngFor="let msg of messages; trackBy: trackByMessageId">
            
            <!-- System Messages -->
            <div *ngIf="msg.type === 'system'" class="system-message">
              <div class="system-message-content">
                <i class="pi pi-info-circle system-icon"></i>
                <span>{{ msg.text }}</span>
              </div>
            </div>

            <!-- Chat Messages -->
            <div *ngIf="msg.type === 'text'" class="message-wrapper" [class.own-message]="msg.sender === 'me'">
              <div class="message-bubble" [class.own-bubble]="msg.sender === 'me'">
                
                <!-- Message Header -->
                <div class="message-header">
                  <span class="sender-name">{{ msg.senderName }}</span>
                  <span class="message-time">{{ msg.timestamp | date: 'shortTime' }}</span>
                </div>

                <!-- Message Content -->
                <div class="message-content">
                  <!-- Text Content -->
                  <div *ngIf="msg.text" class="message-text">{{ msg.text }}</div>
                  
                  <!-- Images -->
                  <div *ngIf="msg.images && msg.images.length > 0" class="message-images">
                    <img 
                      *ngFor="let imageUrl of msg.images" 
                      [src]="imageUrl"
                      alt="Message image"
                      class="message-image"
                    />
                  </div>
                </div>
              </div>
            </div>

          </ng-container>

          <!-- No messages placeholder -->
          <div *ngIf="messages.length === 0" class="no-messages-placeholder">
            <div class="no-messages-content">
              <i class="pi pi-comments no-messages-icon"></i>
              <p class="no-messages-text">{{ isRequest ? 'No messages yet' : 'No chat history available' }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer with Complete + Rating for Requests -->
      <div *ngIf="isRequest" class="complete-footer">
        <div class="footer-content">
          <p-button
            styleClass="complete-button"
            label="Complete"
            icon="pi pi-check"
            [disabled]="completed || !chatAccepted"
            (onClick)="onComplete()"
          ></p-button>

          <!-- Interactive rating for requests -->
          <div class="rating-section">
            <span class="rating-label">Rate this help:</span>
            <p-rating
              [(ngModel)]="rating"
              [disabled]="!completed || rated"
              (onRate)="onRate()"
              styleClass="custom-rating"
            ></p-rating>
            <span *ngIf="rated" class="rated-indicator">
              <i class="pi pi-check"></i> Rated
            </span>
          </div>
        </div>
      </div>

      <!-- Footer with Read-only Rating for Completed Helps -->
      <div *ngIf="isCompletedHelp && shouldShowReadOnlyRating" class="rating-footer">
        <div class="readonly-rating-content">
          <span class="rating-label">Your rating for this help:</span>
          <p-rating
            [ngModel]="displayRating"
            [readonly]="true"
            styleClass="custom-rating readonly-rating"
          ></p-rating>
          <span class="rating-score">({{ displayRating }}/5)</span>
        </div>
      </div>

      <!-- Message when no rating is available for helps -->
      <div *ngIf="isCompletedHelp && !shouldShowReadOnlyRating" class="rating-footer">
        <div class="no-rating-content">
          <span class="no-rating-text">No rating available for this help</span>
        </div>
      </div>
    </div>
  </p-dialog>
</div>