<div class="card">
    <p-table
      #dt2
      [value]="customers"
      dataKey="id"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      [loading]="loading"
      [paginator]="true"
      [globalFilterFields]="['name', 'country.name', 'representative.name', 'status']"
      [tableStyle]="{ 'min-width': '75rem' }"
      selectionMode="single"
      styleClass="p-datatable-striped"
    >
      <ng-template #caption>
        <div class="flex">
          <p-iconfield iconPosition="left" class="ml-auto">
            <p-inputicon>
              <i class="pi pi-search"></i>
            </p-inputicon>
            <input
              pInputText
              type="text"
              [(ngModel)]="searchTerm"
              (input)="dt2.filterGlobal(searchTerm, 'contains')"
              placeholder="Search keyword"
            />
          </p-iconfield>
        </div>
      </ng-template>
  
      <ng-template #header>
        <tr>
          <th style="width:22%">Name</th>
          <th style="width:22%">Country</th>
          <th style="width:22%">Agent</th>
          <th style="width:22%">Status</th>
          <th style="width:12%">Verified</th>
        </tr>
        <tr>
          <th>
            <p-columnFilter type="text" field="name" placeholder="Type to search" ariaLabel="Filter Name" filterOn="input"></p-columnFilter>
          </th>
          <th>
            <p-columnFilter type="text" field="country.name" placeholder="Enter key to search" ariaLabel="Filter Country"></p-columnFilter>
          </th>
          <th>
            <p-columnFilter field="representative" matchMode="in" [showMenu]="false">
              <ng-template #filter let-filter="filterCallback">
                <p-multiselect
                  [(ngModel)]="selectedRepresentatives"
                  [options]="representatives"
                  placeholder="Any"
                  (onChange)="filter($event.value)"
                  optionLabel="name"
                  style="min-width: 14rem"
                  [panelStyle]="{ minWidth: '16rem' }"
                >
                  <ng-template let-option #item>
                    <div class="flex items-center gap-2">
                      <img [alt]="option.label" src="https://primefaces.org/cdn/primeng/images/demo/avatar/{{ option.image }}" style="width: 32px" />
                      <span>{{ option.name }}</span>
                    </div>
                  </ng-template>
                </p-multiselect>
              </ng-template>
            </p-columnFilter>
          </th>
          <th>
            <p-columnFilter field="status" matchMode="equals" [showMenu]="false">
              <ng-template #filter let-filter="filterCallback">
                <p-select
                  [(ngModel)]="selectedStatus"
                  [options]="statuses"
                  (onChange)="filter($event.value)"
                  placeholder="Select One"
                  [showClear]="true"
                  style="min-width: 12rem"
                >
                  <ng-template let-option #item>
                    <p-tag [value]="option.value" [severity]="getSeverity(option.value)" />
                  </ng-template>
                </p-select>
              </ng-template>
            </p-columnFilter>
          </th>
          <th>
            <p-columnFilter type="boolean" field="verified"></p-columnFilter>
          </th>
        </tr>
      </ng-template>
  
      <ng-template #body let-customer>
        <tr (click)="onRowClick(customer, $event)" style="cursor: pointer" class="hover:bg-blue-50">
          <td>{{ customer.name }}</td>
          <td>
            <div class="flex items-center gap-2">
              <img src="https://primefaces.org/cdn/primeng/images/demo/flag/flag_placeholder.png" [class]="'flag flag-' + customer.country.code" style="width: 20px" />
              <span>{{ customer.country.name }}</span>
            </div>
          </td>
          <td>
            <div class="flex items-center gap-2">
              <img [alt]="customer.representative.name" src="https://primefaces.org/cdn/primeng/images/demo/avatar/{{ customer.representative.image }}" width="32" />
              <span>{{ customer.representative.name }}</span>
            </div>
          </td>
          <td>
            <p-tag [value]="customer.status" [severity]="getSeverity(customer.status)" />
          </td>
          <td>
            <i
              class="pi"
              [ngClass]="{
                'text-green-500 pi-check-circle': customer.verified,
                'text-red-500 pi-times-circle': !customer.verified
              }"
            ></i>
          </td>
        </tr>
      </ng-template>
  
      <ng-template #emptymessage>
        <tr>
          <td colspan="5">No customers found.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  
  <!-- User Details Popup -->
  <p-dialog 
    [(visible)]="displayUserDialog" 
    [modal]="true" 
    [style]="{ width: '50vw' }" 
    [draggable]="false" 
    [resizable]="false"
    styleClass="user-details-dialog"
    header="User Details"
    (onHide)="closeDialog()"
  >
    <div class="user-details-content" *ngIf="selectedUser && editingUser">
      <!-- User Avatar and Basic Info -->
      <div class="flex items-center gap-4 mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
        <p-avatar 
          [label]="selectedUser.name.charAt(0)" 
          size="xlarge" 
          styleClass="bg-blue-500 text-white"
          shape="circle"
        ></p-avatar>
        <div>
          <h2 class="text-2xl font-bold text-gray-800 m-0">{{ selectedUser.name }}</h2>
          <p class="text-gray-600 m-0 mb-1">{{ selectedUser.email }}</p>
          <p-tag [value]="selectedUser.role" [severity]="getRoleSeverity(selectedUser.role)" class="text-sm"></p-tag>
        </div>
      </div>
  
      <!-- User Information Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <!-- Personal Information -->
        <p-card header="Personal Information" styleClass="h-full">
          <div class="space-y-4">
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
              <input 
                *ngIf="isEditingMode" 
                type="text" 
                pInputText 
                [(ngModel)]="editingUser.name" 
                class="w-full"
                placeholder="Enter full name"
              />
              <p *ngIf="!isEditingMode" class="text-gray-900 bg-gray-50 p-2 rounded">{{ selectedUser.name }}</p>
            </div>
            
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
              <input 
                *ngIf="isEditingMode" 
                type="email" 
                pInputText 
                [(ngModel)]="editingUser.email" 
                class="w-full"
                placeholder="Enter email address"
              />
              <p *ngIf="!isEditingMode" class="text-gray-900 bg-gray-50 p-2 rounded">{{ selectedUser.email }}</p>
            </div>
            
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
              <input 
                *ngIf="isEditingMode" 
                type="tel" 
                pInputText 
                [(ngModel)]="editingUser.phone" 
                class="w-full"
                placeholder="Enter phone number"
              />
              <p *ngIf="!isEditingMode" class="text-gray-900 bg-gray-50 p-2 rounded">{{ selectedUser.phone }}</p>
            </div>
  
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
              <input 
                *ngIf="isEditingMode" 
                type="text" 
                pInputText 
                [(ngModel)]="editingUser.department" 
                class="w-full"
                placeholder="Enter department"
              />
              <p *ngIf="!isEditingMode" class="text-gray-900 bg-gray-50 p-2 rounded">{{ selectedUser.department }}</p>
            </div>
          </div>
        </p-card>
  
        <!-- System Information -->
        <p-card header="System Information" styleClass="h-full">
          <div class="space-y-4">
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">User ID</label>
              <p class="text-gray-900 bg-gray-50 p-2 rounded">#{{ selectedUser.id }}</p>
            </div>
            
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
              <input 
                *ngIf="isEditingMode" 
                type="text" 
                pInputText 
                [(ngModel)]="editingUser.username" 
                class="w-full"
                placeholder="Enter username"
              />
              <p *ngIf="!isEditingMode" class="text-gray-900 bg-gray-50 p-2 rounded">{{ selectedUser.username }}</p>
            </div>
            
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
              <p-password 
                *ngIf="isEditingMode" 
                [(ngModel)]="editingUser.password" 
                [toggleMask]="true"
                placeholder="Enter new password"
                styleClass="w-full"
                [inputStyleClass]="'w-full'"
              ></p-password>
              <p *ngIf="!isEditingMode" class="text-gray-900 bg-gray-50 p-2 rounded">********</p>
            </div>
  
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
              <p-select 
                *ngIf="isEditingMode"
                [(ngModel)]="editingUser.role" 
                [options]="roles" 
                optionLabel="label" 
                optionValue="value"
                placeholder="Select Role"
                class="w-full"
              >
                <ng-template let-option #item>
                  <p-tag [value]="option.value" [severity]="getRoleSeverity(option.value)" class="text-sm"></p-tag>
                </ng-template>
              </p-select>
              <div *ngIf="!isEditingMode" class="bg-gray-50 p-2 rounded">
                <p-tag [value]="selectedUser.role" [severity]="getRoleSeverity(selectedUser.role)"></p-tag>
              </div>
            </div>
          </div>
        </p-card>
      </div>
  
      <!-- Additional Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <!-- Account Status -->
        <p-card header="Account Status" styleClass="h-full">
          <div class="space-y-4">
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
              <p-select 
                *ngIf="isEditingMode"
                [(ngModel)]="editingUser.status" 
                [options]="statuses" 
                optionLabel="label" 
                optionValue="value"
                placeholder="Select Status"
                class="w-full"
              >
                <ng-template let-option #item>
                  <p-tag [value]="option.value" [severity]="getSeverity(option.value)" class="text-sm"></p-tag>
                </ng-template>
              </p-select>
              <div *ngIf="!isEditingMode" class="bg-gray-50 p-2 rounded">
                <p-tag [value]="selectedUser.status" [severity]="getSeverity(selectedUser.status)"></p-tag>
              </div>
            </div>
  
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Verified Status</label>
              <p-select 
                *ngIf="isEditingMode"
                [(ngModel)]="editingUser.verified" 
                [options]="[{label: 'Verified', value: true}, {label: 'Unverified', value: false}]" 
                optionLabel="label" 
                optionValue="value"
                placeholder="Select Verification Status"
                class="w-full"
              ></p-select>
              <div *ngIf="!isEditingMode" class="bg-gray-50 p-2 rounded">
                <span class="text-sm" [ngClass]="selectedUser.verified ? 'text-green-600' : 'text-red-600'">
                  <i class="pi" [ngClass]="selectedUser.verified ? 'pi-check-circle' : 'pi-times-circle'"></i>
                  {{ selectedUser.verified ? 'Verified' : 'Unverified' }}
                </span>
              </div>
            </div>
          </div>
        </p-card>
  
        <!-- Dates -->
        <p-card header="Timeline" styleClass="h-full">
          <div class="space-y-4">
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Join Date</label>
              <p class="text-gray-900 bg-gray-50 p-2 rounded">{{ selectedUser.date | date:'mediumDate' }}</p>
            </div>
            
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Last Login</label>
              <p class="text-gray-900 bg-gray-50 p-2 rounded">{{ selectedUser.lastLogin | date:'medium' }}</p>
            </div>
          </div>
        </p-card>
      </div>
  
      <p-divider></p-divider>
  
      <!-- Edit Mode Toggle -->
      <div class="mt-4 mb-4 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <i class="pi pi-cog text-blue-500"></i>
          Account Settings
        </h3>
        <p-button 
          [label]="isEditingMode ? 'Cancel Editing' : 'Edit User'" 
          [icon]="isEditingMode ? 'pi pi-times' : 'pi pi-pencil'" 
          (onClick)="toggleEditMode()"
          [severity]="isEditingMode ? 'secondary' : 'info'"
          size="small"
        ></p-button>
      </div>
    </div>
  
    <ng-template #footer>
      <div class="flex justify-end gap-2">
        <p-button 
          label="Close" 
          icon="pi pi-times" 
          (onClick)="closeDialog()" 
          severity="secondary"
          size="small"
        ></p-button>
        <p-button 
          *ngIf="isEditingMode"
          label="Save All Changes" 
          icon="pi pi-check" 
          (onClick)="saveChanges(); toggleEditMode()"
          size="small"
        ></p-button>
      </div>
    </ng-template>
  </p-dialog>