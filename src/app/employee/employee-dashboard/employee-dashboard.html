<div class="dashboard-layout">
  <app-sidebar></app-sidebar>

  <div class="main-wrapper" *ngIf="!loading">
    <div id="mainPage">
      <div class="cards-container">
        <div class="leaderboardCard">
          <leaderboard [helpers]="employeeStats"></leaderboard>
        </div>
        <div class="dialDiv">
          <dial [pointsData]="points" [labels]="['Quota Balance','Earned','Spent']"></dial>
        </div>
      </div>
      <div class="chart">
        <chart-line [requests]="requests" [helps]="helpsProvided"></chart-line>
      </div>

      <div class="historyCard">
        <p-table
          #dt2
          [value]="tableRows"
          dataKey="id"
          [rows]="10"
          [rowsPerPageOptions]="[10,25,50]"
          [loading]="loading"
          [paginator]="true"
          [globalFilterFields]="['requestName','type','dateTime','userName','status','price']">
          
          <!-- global filter -->
          <ng-template #caption>
            <div class="flex">
              <p-iconfield iconPosition="left" class="ml-auto">
                <p-inputicon><i class="pi pi-search"></i></p-inputicon>
                <input
                  #gfilter
                  pInputText
                  type="text"
                  (input)="dt2.filterGlobal(gfilter.value, 'contains')"
                  placeholder="Search requests or helps"/>
              </p-iconfield>
            </div>
          </ng-template>

          <!-- column headers -->
          <ng-template #header>
            <!-- first header row -->
            <tr>
              <th style="width:20%">Request Name</th>
              <th style="width:15%">Type</th>
              <th style="width:20%">Date/Time</th>
              <th style="width:20%">User Name</th>
              <th style="width:15%">Status</th>
              <th style="width:10%">Price</th>
            </tr>
            <!-- filter row -->
            <tr>
              <th><p-columnFilter type="text" field="requestName" filterOn="input"></p-columnFilter></th>
              <th><p-columnFilter type="text" field="type"        filterOn="input"></p-columnFilter></th>
              <th><p-columnFilter type="date" field="dateTime"    filterMatchMode="equals"></p-columnFilter></th>
              <th><p-columnFilter type="text" field="userName"    filterOn="input"></p-columnFilter></th>
              <th>
                <p-columnFilter field="status" matchMode="equals" [showMenu]="false">
                  <ng-template #filter let-value let-filter="filterCallback">
                    <p-select
                      [ngModel]="value"
                      (ngModelChange)="filter($event)"
                      [options]="statuses"
                      placeholder="Select"
                      [showClear]="true"
                      style="min-width:8rem">
                      <ng-template let-option #item>
                        <p-tag [value]="option.value" [severity]="getSeverity(option.value)"></p-tag>
                      </ng-template>
                    </p-select>
                  </ng-template>
                </p-columnFilter>
              </th>
              <th><p-columnFilter type="numeric" field="price" filterMatchMode="gte"></p-columnFilter></th>
            </tr>
          </ng-template>

          <!-- body rows -->
          <ng-template #body let-row>
            <tr (click)="onRowClick(row, $event)" class="clickable-row">
              <td>{{ row.requestName }}</td>
              <td>{{ row.type }}</td>
              <td>{{ row.dateTime | date:'short' }}</td>
              <td>{{ row.userName }}</td>
              <td><p-tag [value]="row.status" [severity]="getSeverity(row.status)"></p-tag></td>
              <td>{{ row.price }}</td>
            </tr>
          </ng-template>

          <!-- empty message -->
          <ng-template #emptymessage>
            <tr><td colspan="6">No records found.</td></tr>
          </ng-template>
        </p-table>
      </div>


    </div>
  </div>
</div>

<!-- âœ… Updated popup with proper event handling -->
<popup 
  #chatPopup 
  [requestId]="selectedRequestId"
  [itemType]="selectedItemType"
  [existingRating]="selectedRating"
  (requestCompleted)="onRequestCompleted()"
></popup>