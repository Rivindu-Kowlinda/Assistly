<!-- request.html -->
<app-sidebar></app-sidebar>
<div class="main-wrapper">
  <p-stepper [(value)]="active">
  
    <!-- STEP 1: Enter Request -->
    <p-step-item [value]="1">
      <p-step>Enter Request</p-step>
      <p-step-panel>
        <ng-template #content let-activateCallback="activateCallback" let-deactivateCallback="deactivateCallback">
          <div class="flex flex-column gap-3">
            <!-- Heading input -->
            <input 
              type="text" 
              pInputText 
              placeholder="Enter Request Heading" 
              [(ngModel)]="requestHeading"
              class="p-inputtext p-component"
            />

            <!-- Rich text input -->
            <textBox 
              #requestTextBox
              (contentChange)="onRequestContentChange($event)"
              [value]="requestContent"
            ></textBox>
          </div>

          <div class="flex py-4 gap-2">
            <p-button 
              label="Next" 
              (onClick)="goToNextStep(activateCallback, 2)"
              [disabled]="!canGoToStep2()"
            ></p-button>
          </div>
        </ng-template>
      </p-step-panel>
    </p-step-item>

    <!-- STEP 2: Select User -->
    <p-step-item [value]="2">
      <p-step>Select User</p-step>
      <p-step-panel>
        <ng-template #content let-activateCallback="activateCallback" let-deactivateCallback="deactivateCallback">
          <div class="flex flex-column h-12rem">
            <div
              class="border-2 border-dashed surface-border border-round surface-ground flex-auto flex justify-content-center align-items-center font-medium"
            >
              <employee-list 
                #employeeListRef
                [selection]="selectedEmployees" 
                (selectionChange)="onEmployeeSelectionChange($event)"
                (balanceUpdated)="onBalanceUpdated($event)"
              ></employee-list>
            </div>
          </div>
          
          <div class="step-validation-messages" *ngIf="selectedEmployees.length === 0 || (employeeList && !employeeList.hasAffordableEmployees)">
            <div class="validation-message error" *ngIf="selectedEmployees.length === 0">
              <i class="pi pi-exclamation-triangle"></i>
              <span>Please select at least one employee to continue.</span>
            </div>
          </div>

          <div class="flex py-4 gap-2">
            <p-button
              label="Back"
              severity="secondary"
              (onClick)="goToPrevStep(deactivateCallback)"
            ></p-button>
            <p-button 
              label="Next" 
              (onClick)="goToNextStep(activateCallback, 3)"
              [disabled]="!canGoToStep3()"
              [title]="!canGoToStep3() ? 'Please select affordable employees to continue' : ''"
            ></p-button>
          </div>
        </ng-template>
      </p-step-panel>
    </p-step-item>

    <!-- STEP 3: Summary -->
    <p-step-item [value]="3">
      <p-step>Summary</p-step>
      <p-step-panel>
        <ng-template #content let-deactivateCallback="deactivateCallback">
          <div class="flex flex-column h-12rem">
            <div
              class="border-2 border-dashed surface-border border-round surface-ground flex-auto flex justify-content-center align-items-center font-medium"
            >
              <div class="summary-container flex w-full">
                <div class="summary-text flex-1">
                  <h4>Request Heading:</h4>
                  <p>{{ requestHeading }}</p>

                  <h4>Request Content:</h4>
                  <div id="requestSummaryText">
                    <textBox 
                      #summaryTextBox 
                      [disabled]="true"
                      [value]="requestContent"
                    ></textBox>
                  </div>
                </div>

                <div id="userSummary" class="flex-1">
                  <h4>Selected Users:</h4>
                  <employee-tabs 
                    [selectedEmployees]="selectedEmployees"
                    (employeeRemoved)="onEmployeeRemoved($event)"
                  ></employee-tabs>
                  
                  <!-- Cost Summary -->
                  <div class="cost-summary" *ngIf="selectedEmployees.length > 0">
                    <div class="cost-explanation">
                      <p class="cost-note">
                        <i class="pi pi-info-circle"></i>
                        Only the employee who accepts your request will be charged.
                      </p>
                    </div>
                    
                    <div class="cost-breakdown">
                      <div class="cost-item">
                        <span class="cost-label">Available Points:</span>
                        <span class="cost-value">{{ getUserBalance() }} points</span>
                      </div>
                      
                      <div class="cost-scenarios">
                        <h5>Potential Costs:</h5>
                        <div class="cost-item scenario best-case">
                          <span class="cost-label">Best Case (Cheapest):</span>
                          <span class="cost-value">{{ getMinPotentialCost() }} points</span>
                        </div>
                        <div class="cost-item scenario worst-case" 
                             [class.insufficient]="!canAffordCurrentSelection()">
                          <span class="cost-label">Worst Case (Most Expensive):</span>
                          <span class="cost-value">{{ getMaxPotentialCost() }} points</span>
                        </div>
                      </div>
                      
                      <div class="cost-item remaining" 
                           [class.insufficient]="!canAffordCurrentSelection()">
                        <span class="cost-label">Minimum Remaining After:</span>
                        <span class="cost-value">
                          {{ getUserBalance() - getMaxPotentialCost() }} points
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="step-validation-messages" *ngIf="!canSubmit()">
            <div class="validation-message error" *ngIf="!canAffordCurrentSelection()">
              <i class="pi pi-wallet"></i>
              <span>Insufficient points for the selected employees.</span>
            </div>
          </div>

          <div class="flex py-4 gap-2">
            <p-button 
              label="Back" 
              severity="secondary"
              (onClick)="goToPrevStep(deactivateCallback)"
            ></p-button>
            <p-button 
              [label]="getSubmitButtonLabel()"
              [disabled]="!canSubmit()"
              (onClick)="onSubmit()"
              [severity]="canSubmit() ? 'success' : 'danger'"
            ></p-button>
          </div>
        </ng-template>
      </p-step-panel>
    </p-step-item>

  </p-stepper>
</div>